<%- include('headers/header', {user: user}); %>
<link rel='stylesheet' type="text/css" href='/plugins/codemirror/lib/codemirror.css'/>
<link rel="stylesheet" type="text/css" href="/plugins/codemirror/theme/ambiance.css"/>
<link rel="stylesheet" type="text/css" href="/plugins/codemirror/theme/solarized.css"/>
<%- include('partials/side-bar', {user: user, activeMenuItem: 'edit-template'}); %>

<div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-10">
        <iframe id="preview-iframe" style="">
        </iframe>
    </div>
    <div class="col-md-1"></div>
</div>
<form id="edit-template-form">
    <div class="row">
        <div class="col-md-6">
            <button type="button" class="btn btn-primary btn-sm" id="edit-template-reload-btn">Preview</button>
        </div>
        <div class="col-md-6">
            <button type="button" class="btn btn-primary btn-sm" id="edit-template-save-btn">Save</button>
        </div>

    </div>
    <h3>HTML</h3>
    <div class="row code-row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
            <textarea name="html-text" id="html-text"></textarea>
        </div>
        <div class="col-md-1"></div>
    </div>

    <h3>CSS</h3>
    <div class="row code-row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
            <textarea name="css-text" id="css-text"></textarea>
        </div>
        <div class="col-md-1"></div>
    </div>
</form>

<%- include('footer'); %>
<script src="/plugins/codemirror/lib/codemirror.js" type="text/javascript"></script>
<script src="/plugins/codemirror/mode/css/css.js" type="text/javascript"></script>
<script src="/plugins/codemirror/mode/javascript/javascript.js" type="text/javascript"></script>
<script src="/plugins/codemirror/mode/xml/xml.js" type="text/javascript"></script>
<script src="/plugins/codemirror/mode/htmlmixed/htmlmixed.js" type="text/javascript"></script>
<script type="text/javascript">
    htmlCodeMirror = CodeMirror.fromTextArea(document.getElementById("html-text"), {lineNumbers: true, mode: "htmlmixed", theme: "ambiance" });
    cssCodeMirror = CodeMirror.fromTextArea(document.getElementById("css-text"), {lineNumbers: true, mode: "css", theme: "ambiance"});

    var cv = <%- JSON.stringify(cv) %>;
    $(document).ready(function() {
        iframeDoc = document.getElementById('preview-iframe').contentWindow.document;
    });

    function fillCV(cv) {
        var e;
        for (i in cv.fields) {
            e = iframeDoc.getElementById(cv.fields[i].name);
            if (e) {
                e.innerHTML = cv.fields[i].value;
            }
        }
    }

    $('#edit-template-reload-btn').click(function() {
        var name = '<%= cv.fields[0].value %> <%= cv.fields[1].value %>';
        var body = $('body', iframeDoc);


        var bootstrapjs = '<script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></sc' + 'ript>';
        body.html(htmlCodeMirror.getValue() + bootstrapjs);
        var head = $('head', iframeDoc);
        var bootstrapcss = "<link rel='stylesheet' href='/bootstrap/css/bootstrap.min.css' />";
        head.html('<title>' + name + '</title><style>' + cssCodeMirror.getValue() + '</style>' + bootstrapcss);
        fillCV(cv);
    });
</script>
